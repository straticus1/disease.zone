---
- name: Deploy application updates to ECS
  hosts: aws
  gather_facts: false

  tasks:
    - name: Build and push updated Docker image
      block:
        - name: Build Docker image
          shell: |
            cd {{ docker_build_path }}
            docker build -t {{ project_name }}:{{ docker_image_tag }} .
          register: docker_build
          changed_when: true

        - name: Get ECR login token
          shell: >
            aws ecr get-login-password --region {{ aws_region }} |
            docker login --username AWS --password-stdin {{ ecr_repository_url }}
          register: ecr_login
          changed_when: false

        - name: Tag Docker image for ECR
          shell: |
            docker tag {{ project_name }}:{{ docker_image_tag }} {{ ecr_repository_url }}:{{ docker_image_tag }}
          register: docker_tag
          changed_when: true

        - name: Push Docker image to ECR
          shell: |
            docker push {{ ecr_repository_url }}:{{ docker_image_tag }}
          register: docker_push
          changed_when: true

    - name: Deploy to ECS
      ecs_service:
        state: present
        name: "{{ ecs_service_name }}"
        cluster: "{{ ecs_cluster_name }}"
        region: "{{ aws_region }}"
        force_new_deployment: true
        wait: true

    - name: Wait for deployment to complete
      uri:
        url: "https://{{ domain_name }}/api/health"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 30

    - name: Display deployment status
      debug:
        msg: "Deployment completed successfully! Application is healthy at https://{{ domain_name }}"