<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Health Emergency & Outbreak Alerts - diseaseZone</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #fd7e14 0%, #e8650e 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .alert-dashboard {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .alert-level {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .alert-level.critical { background: #dc3545; color: white; }
        .alert-level.high { background: #fd7e14; color: white; }
        .alert-level.moderate { background: #ffc107; color: black; }
        .alert-level.low { background: #28a745; color: white; }

        .outbreak-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .outbreak-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-left: 5px solid #fd7e14;
            transition: transform 0.3s;
        }

        .outbreak-card:hover {
            transform: translateY(-5px);
        }

        .outbreak-card.severity-4, .outbreak-card.severity-5 {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        }

        .outbreak-card.severity-3 {
            border-left-color: #fd7e14;
            background: linear-gradient(135deg, #fff8f0 0%, #fff 100%);
        }

        .outbreak-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .outbreak-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .outbreak-location {
            color: #666;
            font-size: 0.9em;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .severity-1 { background: #d1ecf1; color: #0c5460; }
        .severity-2 { background: #fff3cd; color: #856404; }
        .severity-3 { background: #ffeaa7; color: #b8860b; }
        .severity-4 { background: #f8d7da; color: #721c24; }
        .severity-5 { background: #d1ecf1; color: #155724; }

        .outbreak-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #fd7e14;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
        }

        .search-controls {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-btn {
            background: linear-gradient(135deg, #fd7e14 0%, #e8650e 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .nav-back {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .nav-back:hover {
            background: rgba(255,255,255,0.3);
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .timeline-date {
            background: #fd7e14;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-back">‚Üê Back to Main Portal</a>
        
        <div class="header">
            <h1>üö® Public Health Emergency & Outbreak Alerts</h1>
            <p>Real-time global outbreak surveillance from WHO, CDC, and ProMED</p>
        </div>

        <div class="alert-dashboard">
            <h3>Global Alert Level</h3>
            <div class="alert-level moderate" id="globalAlertLevel">
                üü° MODERATE - Monitoring active outbreaks globally
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="search-btn" onclick="loadActiveOutbreaks()">üîÑ Refresh Active Outbreaks</button>
                <button class="search-btn" onclick="generateAlerts()" style="margin-left: 10px;">‚ö° Generate New Alerts</button>
            </div>
        </div>

        <div class="search-controls">
            <h3>Filter Outbreaks</h3>
            <div class="filter-grid">
                <div class="form-group">
                    <label for="diseaseFilter">Disease</label>
                    <input type="text" id="diseaseFilter" placeholder="e.g., COVID-19, Dengue, Cholera">
                </div>
                <div class="form-group">
                    <label for="regionFilter">Region</label>
                    <select id="regionFilter">
                        <option value="">All Regions</option>
                        <option value="AFRO">Africa (AFRO)</option>
                        <option value="AMRO">Americas (AMRO)</option>
                        <option value="SEARO">South-East Asia (SEARO)</option>
                        <option value="EURO">Europe (EURO)</option>
                        <option value="EMRO">Eastern Mediterranean (EMRO)</option>
                        <option value="WPRO">Western Pacific (WPRO)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="severityFilter">Minimum Severity</label>
                    <select id="severityFilter">
                        <option value="">All Levels</option>
                        <option value="1">Level 1 - Watch</option>
                        <option value="2">Level 2 - Advisory</option>
                        <option value="3">Level 3 - Alert</option>
                        <option value="4">Level 4 - Warning</option>
                        <option value="5">Level 5 - Emergency</option>
                    </select>
                </div>
                <button class="search-btn" onclick="searchOutbreaks()">üîç Filter Outbreaks</button>
            </div>
        </div>

        <div id="outbreaksContainer">
            <div class="loading">Loading active outbreaks...</div>
        </div>
    </div>

    <script>
        // Load active outbreaks on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadActiveOutbreaks();
        });

        async function loadActiveOutbreaks() {
            const container = document.getElementById('outbreaksContainer');
            container.innerHTML = '<div class="loading">Loading active outbreaks...</div>';

            try {
                const response = await fetch('/api/outbreak-alerts/active?limit=20');
                const data = await response.json();

                if (data.outbreaks && data.outbreaks.length > 0) {
                    // Update global alert level
                    updateGlobalAlertLevel(data.alertLevel);

                    // Display outbreaks
                    const outbreaksHTML = data.outbreaks.map(outbreak => createOutbreakCard(outbreak)).join('');
                    container.innerHTML = `
                        <h3>Active Outbreaks (${data.totalFound})</h3>
                        <div class="outbreak-cards">
                            ${outbreaksHTML}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 15px;"><h4>No active outbreaks found</h4></div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 15px;">Error loading outbreaks: ${error.message}</div>`;
            }
        }

        async function searchOutbreaks() {
            const disease = document.getElementById('diseaseFilter').value.trim();
            const region = document.getElementById('regionFilter').value;
            const severity = document.getElementById('severityFilter').value;

            const params = new URLSearchParams();
            if (disease) params.append('disease', disease);
            if (region) params.append('region', region);
            if (severity) params.append('severity', severity);
            params.append('limit', '20');

            const container = document.getElementById('outbreaksContainer');
            container.innerHTML = '<div class="loading">Searching outbreaks...</div>';

            try {
                const response = await fetch(`/api/outbreak-alerts/active?${params}`);
                const data = await response.json();

                if (data.outbreaks && data.outbreaks.length > 0) {
                    const outbreaksHTML = data.outbreaks.map(outbreak => createOutbreakCard(outbreak)).join('');
                    container.innerHTML = `
                        <h3>Filtered Outbreaks (${data.totalFound})</h3>
                        <div class="outbreak-cards">
                            ${outbreaksHTML}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 15px;"><h4>No outbreaks match the selected filters</h4></div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 15px;">Error searching outbreaks: ${error.message}</div>`;
            }
        }

        async function generateAlerts() {
            const container = document.getElementById('outbreaksContainer');
            container.innerHTML = '<div class="loading">Generating real-time alerts...</div>';

            try {
                const response = await fetch('/api/outbreak-alerts/generate-alerts?severityThreshold=3');
                const data = await response.json();

                if (data.alerts && data.alerts.length > 0) {
                    const alertsHTML = data.alerts.map(alert => `
                        <div class="outbreak-card ${alert.type === 'urgent' ? 'severity-4' : 'severity-3'}">
                            <div class="outbreak-header">
                                <div>
                                    <div class="outbreak-title">${alert.title}</div>
                                    <div class="outbreak-location">${alert.region}</div>
                                </div>
                                <span class="severity-badge severity-${alert.outbreak.severity}">${alert.type.toUpperCase()}</span>
                            </div>
                            <p style="margin: 10px 0;">${alert.message}</p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <strong>Recommended Actions:</strong>
                                <ul style="margin: 5px 0 0 20px;">
                                    ${alert.actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="text-align: right; font-size: 0.8em; color: #666;">
                                Alert generated: ${new Date(alert.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = `
                        <h3>üö® Real-time Alerts (${data.totalAlerts})</h3>
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <strong>Alert Summary:</strong> ${data.urgentAlerts} urgent alert(s) generated from ${data.totalAlerts} total alerts
                        </div>
                        <div class="outbreak-cards">
                            ${alertsHTML}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 15px;"><h4>No alerts generated - all outbreaks below threshold</h4></div>';
                }
            } catch (error) {
                container.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 15px;">Error generating alerts: ${error.message}</div>`;
            }
        }

        function createOutbreakCard(outbreak) {
            const caseFatalityRate = outbreak.caseFatalityRate || '0.0';
            const daysSinceUpdate = outbreak.daysSinceLastUpdate || 0;
            
            return `
                <div class="outbreak-card severity-${outbreak.severity}">
                    <div class="outbreak-header">
                        <div>
                            <div class="outbreak-title">${outbreak.disease}</div>
                            <div class="outbreak-location">üìç ${outbreak.location}, ${outbreak.regionName}</div>
                        </div>
                        <span class="severity-badge severity-${outbreak.severity}">${outbreak.severityInfo?.level || 'Unknown'}</span>
                    </div>
                    
                    <div class="outbreak-stats">
                        <div class="stat-item">
                            <div class="stat-number">${outbreak.casesReported.toLocaleString()}</div>
                            <div class="stat-label">Cases</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${outbreak.deathsReported}</div>
                            <div class="stat-label">Deaths</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${caseFatalityRate}%</div>
                            <div class="stat-label">CFR</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${outbreak.riskScore || 0}</div>
                            <div class="stat-label">Risk Score</div>
                        </div>
                    </div>

                    <p style="margin: 15px 0; color: #555;">${outbreak.description}</p>

                    ${outbreak.affectedAreas && outbreak.affectedAreas.length > 0 ? `
                        <div style="margin: 10px 0;">
                            <strong>Affected Areas:</strong> ${outbreak.affectedAreas.join(', ')}
                        </div>
                    ` : ''}

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 0.9em; color: #666;">
                        <div>Status: <strong style="color: ${outbreak.status === 'expanding' ? '#dc3545' : outbreak.status === 'declining' ? '#28a745' : '#ffc107'}">${outbreak.status}</strong></div>
                        <div>Updated ${daysSinceUpdate} day(s) ago</div>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="viewOutbreakDetails('${outbreak.id}')" style="background: #fd7e14; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }

        function updateGlobalAlertLevel(alertLevel) {
            const element = document.getElementById('globalAlertLevel');
            const level = alertLevel?.level || 'low';
            const color = alertLevel?.color || '#27ae60';
            
            const icons = {
                'critical': 'üî¥',
                'high': 'üü†', 
                'moderate': 'üü°',
                'low': 'üü¢'
            };

            element.className = `alert-level ${level}`;
            element.innerHTML = `${icons[level]} ${level.toUpperCase()} - Global outbreak monitoring active`;
            element.style.background = color;
        }

        async function viewOutbreakDetails(outbreakId) {
            try {
                const response = await fetch(`/api/outbreak-alerts/details/${outbreakId}`);
                const data = await response.json();

                if (data.error) {
                    alert(`Error loading details: ${data.error}`);
                    return;
                }

                // Create a modal or new window with detailed information
                const detailsWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                detailsWindow.document.write(`
                    <html>
                    <head>
                        <title>Outbreak Details - ${data.disease}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                            .header { background: #fd7e14; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                            .section { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; }
                            .risk-high { background: #f8d7da; }
                            .risk-medium { background: #fff3cd; }
                            .risk-low { background: #d1ecf1; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>${data.disease} Outbreak</h1>
                            <p>üìç ${data.location}, ${data.regionName}</p>
                        </div>
                        
                        <div class="section">
                            <h3>Overview</h3>
                            <p><strong>Description:</strong> ${data.description}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Severity Level:</strong> ${data.severity}/5 (${data.severityInfo?.description})</p>
                            <p><strong>Risk Score:</strong> ${data.riskScore}/100</p>
                        </div>

                        <div class="section">
                            <h3>Statistics</h3>
                            <p><strong>Cases Reported:</strong> ${data.casesReported?.toLocaleString()}</p>
                            <p><strong>Deaths Reported:</strong> ${data.deathsReported}</p>
                            <p><strong>Case Fatality Rate:</strong> ${data.caseFatalityRate}%</p>
                            <p><strong>First Reported:</strong> ${data.firstReported}</p>
                            <p><strong>Last Update:</strong> ${data.lastUpdate}</p>
                        </div>

                        ${data.interventions ? `
                            <div class="section">
                                <h3>Recommended Interventions</h3>
                                <ul>
                                    ${data.interventions.map(intervention => `<li>${intervention}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${data.riskAssessment ? `
                            <div class="section risk-${data.riskAssessment.overallRisk?.toLowerCase()}">
                                <h3>Risk Assessment</h3>
                                <p><strong>Overall Risk:</strong> ${data.riskAssessment.overallRisk}</p>
                                <p><strong>Spread Risk:</strong> ${data.riskAssessment.spreadRisk}</p>
                                <p><strong>Health System Impact:</strong> ${data.riskAssessment.healthSystemImpact}</p>
                            </div>
                        ` : ''}
                    </body>
                    </html>
                `);
                
                detailsWindow.document.close();
            } catch (error) {
                alert(`Error loading outbreak details: ${error.message}`);
            }
        }
    </script>
</body>
</html>