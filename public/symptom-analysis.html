<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Symptom Analysis - diseaseZone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .symptom-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .symptom-card:hover {
            transform: translateY(-5px);
        }

        .analysis-phase {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px 0;
        }

        .disorder-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .confidence-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
            transition: width 0.3s ease;
        }

        .medical-disclaimer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-primary-custom:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-dna me-2"></i>diseaseZone
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="dashboard.html">Dashboard</a>
                <a class="nav-link active" href="symptom-analysis.html">Symptom Analysis</a>
                <a class="nav-link" href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="gradient-bg p-4 rounded-3 text-center">
                    <h1 class="display-4 mb-3">
                        <i class="fas fa-brain me-3"></i>AI Symptom Analysis
                    </h1>
                    <p class="lead">
                        Advanced AI-powered symptom analysis using your personal and family medical history
                    </p>
                    <div class="medical-disclaimer">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Medical Disclaimer</h5>
                        <p class="mb-0">This analysis is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always consult with a healthcare provider for proper medical evaluation.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Session -->
        <div id="analysisSection" class="row mt-4" style="display: none;">
            <div class="col-lg-8">
                <!-- Current Phase Display -->
                <div id="currentPhase" class="text-center mb-4">
                    <span class="analysis-phase">
                        <i class="fas fa-clipboard-check me-2"></i>
                        <span id="phaseText">Initial Screening</span>
                    </span>
                </div>

                <!-- Questions Section -->
                <div id="questionsSection">
                    <div class="symptom-card card">
                        <div class="card-body">
                            <h4 class="card-title mb-4">
                                <i class="fas fa-question-circle me-2"></i>
                                Questions
                            </h4>
                            <div id="questionsList"></div>
                            <div class="text-center mt-4">
                                <button id="submitResponses" class="btn btn-primary-custom btn-lg">
                                    <i class="fas fa-paper-plane me-2"></i>Submit Responses
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Section -->
                <div id="loadingSection" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4 class="mt-3">Analyzing your symptoms...</h4>
                    <p class="text-muted">Our AI is processing your responses and comparing them with medical databases.</p>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Progress Panel -->
                <div class="symptom-card card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line me-2"></i>Analysis Progress
                        </h5>
                        <div id="progressInfo">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Symptoms Collected:</span>
                                <span id="symptomsCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Questions Answered:</span>
                                <span id="responsesCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Candidate Disorders:</span>
                                <span id="candidatesCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Candidates -->
                <div id="candidatesPanel" class="symptom-card card mt-3" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-list-ol me-2"></i>Current Analysis
                        </h5>
                        <div id="currentCandidates"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Analysis Section -->
        <div id="startSection" class="row mt-4">
            <div class="col-lg-8 mx-auto">
                <div class="symptom-card card">
                    <div class="card-body text-center">
                        <h3 class="card-title mb-4">
                            <i class="fas fa-play-circle me-2"></i>
                            Start Your Symptom Analysis
                        </h3>
                        <p class="card-text mb-4">
                            Our AI will ask you a series of questions about your symptoms and use your family medical history to provide personalized disorder predictions.
                        </p>

                        <div class="row text-start mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-check-circle text-success me-2"></i>What We'll Do:</h5>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Adaptive questioning</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Family history integration</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>AI-powered analysis</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Progressive narrowing to final prediction</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5><i class="fas fa-list text-info me-2"></i>You'll Get:</h5>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Top 10 possible disorders</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Top 5 refined predictions</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Top 3 most likely conditions</li>
                                    <li><i class="fas fa-chevron-right text-primary me-2"></i>Final AI prediction with recommendations</li>
                                </ul>
                            </div>
                        </div>

                        <button id="startAnalysis" class="btn btn-primary-custom btn-lg">
                            <i class="fas fa-brain me-2"></i>Start AI Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Results Section -->
        <div id="resultsSection" class="row mt-4" style="display: none;">
            <div class="col-12">
                <div class="symptom-card card">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Analysis Complete - Your Results
                        </h3>
                        <div id="finalResults"></div>

                        <div class="text-center mt-4">
                            <button id="startNewAnalysis" class="btn btn-primary-custom me-3">
                                <i class="fas fa-redo me-2"></i>Start New Analysis
                            </button>
                            <button id="viewHistory" class="btn btn-outline-primary">
                                <i class="fas fa-history me-2"></i>View History
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-history me-2"></i>Analysis History
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="historyContent">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let currentQuestions = [];
        let authToken = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            authToken = localStorage.getItem('authToken') || getCookie('session_token');
            if (!authToken) {
                window.location.href = 'login.html';
                return;
            }

            // Setup event listeners
            document.getElementById('startAnalysis').addEventListener('click', startSymptomAnalysis);
            document.getElementById('submitResponses').addEventListener('click', submitResponses);
            document.getElementById('startNewAnalysis').addEventListener('click', resetAnalysis);
            document.getElementById('viewHistory').addEventListener('click', showHistory);
        });

        // Start new symptom analysis
        async function startSymptomAnalysis() {
            try {
                showLoading();

                const response = await fetch('/api/user/symptom-analysis/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.data.session_id;
                    currentQuestions = result.data.initial_questions;

                    document.getElementById('startSection').style.display = 'none';
                    document.getElementById('analysisSection').style.display = 'block';

                    displayQuestions(currentQuestions);
                    updateProgress(0, 0, 0);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error starting analysis:', error);
                alert('Failed to start analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display questions
        function displayQuestions(questions) {
            const questionsList = document.getElementById('questionsList');
            questionsList.innerHTML = '';

            questions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.innerHTML = `
                    <h6 class="mb-3">
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        ${question.question}
                        ${question.required ? '<span class="text-danger">*</span>' : ''}
                    </h6>
                    <textarea
                        class="form-control"
                        id="response_${question.id}"
                        rows="3"
                        placeholder="Please describe your symptoms in detail..."
                        ${question.required ? 'required' : ''}
                    ></textarea>
                `;
                questionsList.appendChild(questionCard);
            });
        }

        // Submit responses
        async function submitResponses() {
            try {
                // Collect responses
                const responses = [];
                currentQuestions.forEach(question => {
                    const responseElement = document.getElementById(`response_${question.id}`);
                    if (responseElement && responseElement.value.trim()) {
                        responses.push({
                            question_id: question.id,
                            question: question.question,
                            answer: responseElement.value.trim()
                        });
                    }
                });

                if (responses.length === 0) {
                    alert('Please answer at least one question before submitting.');
                    return;
                }

                showLoading();

                const response = await fetch(`/api/user/symptom-analysis/${currentSessionId}/responses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ responses })
                });

                const result = await response.json();

                if (result.success) {
                    // Update progress
                    const data = result.data;
                    updateProgress(
                        data.symptoms?.length || 0,
                        responses.length,
                        data.disorder_candidates?.total_candidates || 0
                    );

                    // Update phase
                    updatePhase(data.current_phase);

                    // Show candidates if available
                    if (data.disorder_candidates) {
                        displayCandidates(data.disorder_candidates);
                    }

                    // Check if we have follow-up questions
                    if (data.follow_up_questions && data.follow_up_questions.length > 0) {
                        currentQuestions = data.follow_up_questions;
                        displayQuestions(currentQuestions);
                    } else {
                        // Complete analysis
                        completeAnalysis();
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error submitting responses:', error);
                alert('Failed to submit responses: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Complete analysis
        async function completeAnalysis() {
            try {
                showLoading();

                const response = await fetch(`/api/user/symptom-analysis/${currentSessionId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    displayFinalResults(result.data);
                    document.getElementById('analysisSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error completing analysis:', error);
                alert('Failed to complete analysis: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display final results
        function displayFinalResults(report) {
            const resultsContainer = document.getElementById('finalResults');

            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-trophy text-warning me-2"></i>Top 10 Possible Disorders</h5>
                        ${formatDisorderList(report.top_10_disorders)}
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-medal text-info me-2"></i>Top 5 Refined Predictions</h5>
                        ${formatDisorderList(report.top_5_disorders)}
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5><i class="fas fa-star text-success me-2"></i>Top 3 Most Likely</h5>
                        ${formatDisorderList(report.top_3_disorders)}
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-brain text-primary me-2"></i>Final AI Prediction</h5>
                        ${formatFinalPrediction(report.final_prediction)}
                    </div>
                </div>

                <div class="mt-4">
                    <h5><i class="fas fa-lightbulb text-warning me-2"></i>Recommendations</h5>
                    <ul class="list-group list-group-flush">
                        ${report.recommendations.map(rec => `<li class="list-group-item"><i class="fas fa-arrow-right text-primary me-2"></i>${rec}</li>`).join('')}
                    </ul>
                </div>

                <div class="medical-disclaimer mt-4">
                    <strong>Medical Disclaimer:</strong> ${report.medical_disclaimer}
                </div>
            `;

            resultsContainer.innerHTML = html;
        }

        // Format disorder list
        function formatDisorderList(disorders) {
            if (!disorders || disorders.length === 0) {
                return '<p class="text-muted">No disorders identified</p>';
            }

            return disorders.map(disorder => `
                <div class="disorder-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>${disorder.disorder_name}</strong>
                        <span class="badge bg-info">${Math.round(disorder.confidence * 100)}%</span>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${disorder.confidence * 100}%"></div>
                    </div>
                    <small class="text-muted">ICD-10: ${disorder.icd10_code} | ${disorder.recommendation}</small>
                </div>
            `).join('');
        }

        // Format final prediction
        function formatFinalPrediction(prediction) {
            if (!prediction) {
                return '<p class="text-muted">No final prediction available</p>';
            }

            return `
                <div class="alert alert-primary">
                    <h6 class="alert-heading">${prediction.disorder_name}</h6>
                    <div class="confidence-bar mb-2">
                        <div class="confidence-fill" style="width: ${prediction.confidence * 100}%"></div>
                    </div>
                    <p class="mb-2"><strong>Confidence:</strong> ${Math.round(prediction.confidence * 100)}%</p>
                    <p class="mb-2"><strong>ICD-10 Code:</strong> ${prediction.icd10_code}</p>
                    <p class="mb-2"><strong>Urgency:</strong> <span class="badge bg-${prediction.urgency === 'emergency' ? 'danger' : prediction.urgency === 'urgent' ? 'warning' : 'success'}">${prediction.urgency}</span></p>
                    <p class="mb-0"><strong>Recommendation:</strong> ${prediction.recommendation}</p>
                </div>
            `;
        }

        // Update progress display
        function updateProgress(symptoms, responses, candidates) {
            document.getElementById('symptomsCount').textContent = symptoms;
            document.getElementById('responsesCount').textContent = responses;
            document.getElementById('candidatesCount').textContent = candidates;
        }

        // Update current phase
        function updatePhase(phase) {
            const phaseNames = {
                'initial_screening': 'Initial Screening',
                'narrowing_to_10': 'Narrowing to Top 10',
                'narrowing_to_5': 'Refining to Top 5',
                'narrowing_to_3': 'Focusing on Top 3',
                'final_assessment': 'Final Assessment'
            };

            document.getElementById('phaseText').textContent = phaseNames[phase] || phase;
        }

        // Display current candidates
        function displayCandidates(candidates) {
            const panel = document.getElementById('candidatesPanel');
            const container = document.getElementById('currentCandidates');

            if (candidates.top_3) {
                container.innerHTML = formatDisorderList(candidates.top_3);
                panel.style.display = 'block';
            }
        }

        // Show analysis history
        async function showHistory() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('historyModal'));
                modal.show();

                const response = await fetch('/api/user/symptom-analysis/history', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const historyContent = document.getElementById('historyContent');

                    if (result.data.history.length === 0) {
                        historyContent.innerHTML = '<p class="text-muted">No previous analyses found.</p>';
                    } else {
                        historyContent.innerHTML = result.data.history.map(session => `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">${session.predicted_disorder || 'Analysis In Progress'}</h6>
                                            <p class="card-text">
                                                <small class="text-muted">
                                                    ${new Date(session.created_at).toLocaleDateString()} |
                                                    Phase: ${session.current_phase}
                                                    ${session.confidence ? ` | Confidence: ${Math.round(session.confidence * 100)}%` : ''}
                                                </small>
                                            </p>
                                        </div>
                                        <span class="badge bg-${session.status === 'completed' ? 'success' : 'warning'}">${session.status}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContent').innerHTML = '<p class="text-danger">Failed to load history.</p>';
            }
        }

        // Reset for new analysis
        function resetAnalysis() {
            currentSessionId = null;
            currentQuestions = [];

            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('startSection').style.display = 'block';

            updateProgress(0, 0, 0);
            updatePhase('initial_screening');
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('questionsSection').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('questionsSection').style.display = 'block';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('authToken');
            document.cookie = 'session_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>